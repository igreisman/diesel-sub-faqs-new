<script>
    // Global variables
    let currentCategories = [];
    let currentFAQs = [];

    // API endpoint helper
    function getApiUrl(path) {
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            return `http://localhost:5001${path}`;
        }
        return path;
    }

    // Enhanced markdown renderer for answers
    function renderMarkdown(text) {
        if (!text) return '';

        // First, handle block-level elements
        let html = text
            // Handle block quotes
            .replace(/^> (.+)$/gm, '<blockquote class="blockquote border-start border-primary ps-3 ms-3 text-muted">$1</blockquote>')

            // Handle headers (h1-h6)
            .replace(/^### (.+)$/gm, '<h5>$1</h5>')
            .replace(/^## (.+)$/gm, '<h4>$1</h4>')
            .replace(/^# (.+)$/gm, '<h3>$1</h3>')

            // Handle horizontal rules
            .replace(/^---$/gm, '<hr>')

            // Handle unordered lists (- item)
            .replace(/^- (.+)$/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')

            // Handle ordered lists (1. item, 2. item, etc.)
            .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')

            // Handle code blocks (triple backticks)
            .replace(/```([^`]+)```/g, '<pre class="bg-light p-2 rounded"><code>$1</code></pre>')

            // Handle inline code
            .replace(/`([^`]+)`/g, '<code class="bg-light px-1 rounded">$1</code>')

            // Handle bold and italic
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/\*([^*]+)\*/g, '<em>$1</em>')

            // Handle links
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="text-decoration-none">$1</a>')

            // Handle line breaks - convert double newlines to paragraphs, single newlines to <br>
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>');

        // Wrap in paragraph tags if not already wrapped in block elements
        if (!html.includes('<p>') && !html.includes('<ul>') && !html.includes('<ol>') && !html.includes('<blockquote>')) {
            html = '<p>' + html + '</p>';
        } else if (html.includes('</p><p>')) {
            html = '<p>' + html + '</p>';
        }

        // Clean up any empty paragraphs
        html = html.replace(/<p><\/p>/g, '');

        return html;
    }

    // Strip markdown from questions to make them plain text
    function stripMarkdown(text) {
        if (!text) return '';
        return text
            .replace(/\*\*([^*]+)\*\*/g, '$1')  // Remove bold markers
            .replace(/\*([^*]+)\*/g, '$1')      // Remove italic markers
            .replace(/\{\.underline\}/g, '')    // Remove {.underline} markers
            .replace(/\{[^}]*\}/g, '')          // Remove any other {attribute} markers
            .replace(/\[([^\]]+)\]/g, '$1')     // Remove square brackets, keep content
            .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')  // Remove links, keep text
            .replace(/~~([^~]+)~~/g, '$1')      // Remove strikethrough markers
            .replace(/`([^`]+)`/g, '$1')        // Remove code markers
            .replace(/#{1,6}\s*/g, '')          // Remove heading markers
            .replace(/\n/g, ' ')                // Replace newlines with spaces
            .replace(/\s+/g, ' ')               // Normalize multiple spaces
            .trim();
    }

    // Show specific section
    function showSection(sectionId) {
        document.getElementById('categoriesSection').style.display = 'none';
        document.getElementById('faqsSection').style.display = 'none';
        document.getElementById('searchSection').style.display = 'none';
        document.getElementById(sectionId).style.display = 'block';
    }

    // Show categories
    function showCategories() {
        showSection('categoriesSection');
        document.getElementById('searchInput').value = '';
    }

    // Load categories from API
    async function loadCategories() {
        // Clear any existing error messages first
        document.getElementById('categories').innerHTML = '<div class="col-12"><div class="text-center">Loading categories...</div></div>';

        try {
            const response = await fetch(getApiUrl('/api/corrected-faqs?action=categories'));

            if (!response.ok) {
                throw new Error(`API failed: ${response.status} ${response.statusText}`);
            }

            const categories = await response.json();
            currentCategories = categories;

            let html = '';
            categories.forEach(category => {
                let icon = '';
                switch (category.name) {
                    case 'Hull and Compartments':
                        icon = `<svg class='category-icon' viewBox="0 0 40 40" fill="none"><rect x="0" y="15" width="40" height="10" rx="5" fill="#1976d2"/><rect x="8" y="5" width="24" height="30" rx="12" fill="#ffd600"/><rect x="18" y="0" width="4" height="15" rx="2" fill="#43a047"/></svg>`;
                        break;
                    case 'US WW2 Subs in General':
                        icon = `<svg class='category-icon' viewBox="0 0 40 40" fill="none"><ellipse cx="20" cy="32" rx="18" ry="8" fill="#2a5298"/><rect x="10" y="5" width="20" height="25" rx="10" fill="#ff7043"/><circle cx="20" cy="13" r="6" fill="#ffd600"/></svg>`;
                        break;
                    case 'Operating US Subs in WW2':
                        icon = `<svg class='category-icon' viewBox="0 0 40 40" fill="none"><rect x="2" y="28" width="36" height="8" rx="4" fill="#1e88e5"/><rect x="18" y="5" width="4" height="23" rx="2" fill="#ff7043"/><circle cx="20" cy="13" r="4" fill="#ffd600"/></svg>`;
                        break;
                    case 'Who Were the Crews Aboard WW2 US Subs':
                        icon = `<svg class='category-icon' viewBox="0 0 40 40" fill="none"><circle cx="20" cy="14" r="10" fill="#ffd600"/><rect x="8" y="26" width="24" height="10" rx="5" fill="#43a047"/><rect x="14" y="5" width="12" height="6" rx="3" fill="#1e88e5"/></svg>`;
                        break;
                    case 'Life Aboard WW2 US Subs':
                        icon = `<svg class='category-icon' viewBox="0 0 40 40" fill="none"><rect x="7" y="25" width="26" height="8" rx="4" fill="#43a047"/><circle cx="20" cy="14" r="8" fill="#ffd600"/><rect x="18" y="5" width="4" height="8" rx="2" fill="#1e88e5"/></svg>`;
                        break;
                    case 'Attacks and Battles, Small and Large':
                        icon = `<svg class='category-icon' viewBox="0 0 40 40" fill="none"><rect x="2" y="30" width="36" height="6" rx="3" fill="#d32f2f"/><polygon points="20,4 36,30 4,30" fill="#ffd600"/><circle cx="20" cy="12" r="4" fill="#1e88e5"/></svg>`;
                        break;
                    default:
                        icon = `<svg class='category-icon' viewBox="0 0 40 40" fill="none"><rect x="0" y="15" width="40" height="10" rx="5" fill="#1e3c72"/></svg>`;
                }
                html += `
                        <div class="col-md-4 mb-4">
                            <div class="card category-card h-100" onclick="loadFAQs(${category.id}, '${category.name}')">
                                <div class="card-body">
                                    <div style="display: flex; align-items: center; margin-bottom: 6px;">
                                        <span style='flex-shrink:0;display:inline-block;'>${icon}</span>
                                        <span style="font-size: 1.35rem; font-weight: bold;">${category.name}</span>
                                    </div>
                                    <p class="card-text mb-1">${category.description}</p>
                                    <span class="badge bg-success">Click to Browse FAQs</span>
                                </div>
                            </div>
                        </div>
                    `;
            });

            document.getElementById('categories').innerHTML = html;
            document.getElementById('stats').innerHTML = 'Ready! 166 FAQs across 6 categories';
        } catch (error) {
            console.error('Error loading categories:', error);
            document.getElementById('categories').innerHTML = '<div class="col-12"><div class="alert alert-danger">Failed to load categories: ' + error.message + '</div></div>';
        }
    }

    // Load FAQs for category
    async function loadFAQs(categoryId, categoryName) {
        try {
            const response = await fetch(getApiUrl(`/api/corrected-faqs?action=faqs&category_id=${categoryId}`));
            const faqs = await response.json();

            document.getElementById('faqsTitle').textContent = categoryName;

            let html = '';
            faqs.forEach((faq, index) => {
                if (faq.answer) {
                    const processedAnswer = renderMarkdown(faq.answer);
                    const cleanQuestion = stripMarkdown(faq.question);
                    html += `
                            <div class="faq-item">
                                <div class="card">
                                    <div class="card-header faq-question" onclick="toggleFAQ(${index})">
                                        <h6 class="mb-0">ðŸ”¸ ${cleanQuestion}</h6>
                                    </div>
                                    <div id="faq-${index}" class="faq-answer">
                                        <div class="faq-feedback-box">
                                            <small class="text-muted">
                                                ðŸ’¡ Have additional info or corrections about this FAQ? 
                                                <button class="btn btn-link btn-sm p-0 text-decoration-none" 
                                                        onclick="openFeedbackModal(${faq.id}, '${cleanQuestion.replace(/'/g, "\\'")}')">
                                                    ï¿½ Submit feedback
                                                </button>
                                            </small>
                                        </div>
                                        <div class="card-body">
                                            ${processedAnswer}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                }
            });

            document.getElementById('faqs').innerHTML = html;
            showSection('faqsSection');
        } catch (error) {
            alert('Error loading FAQs: ' + error.message);
        }
    }

    // Toggle FAQ answer visibility
    function toggleFAQ(index) {
        const answer = document.getElementById(`faq-${index}`);
        answer.style.display = answer.style.display === 'block' ? 'none' : 'block';
    }

    // Search FAQs
    async function searchFAQs() {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) return;

        // Check if whole word search is enabled
        const wholeWord = document.getElementById('wholeWordCheckbox').checked;

        try {
            // Fetch as usual
            const response = await fetch(getApiUrl(`/api/corrected-faqs?action=search&q=${encodeURIComponent(query)}`));
            let results = await response.json();

            // If whole word is checked, filter results client-side
            if (wholeWord) {
                // Create a regex for whole word match (case-insensitive)
                const wordRegex = new RegExp(`\\b${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
                results = results.filter(faq => {
                    // Check in question and answer
                    return wordRegex.test(stripMarkdown(faq.question)) || wordRegex.test(faq.answer);
                });
            }

            document.getElementById('searchTitle').textContent = `Search Results for "${query}"`;

            if (results.length === 0) {
                document.getElementById('searchResults').innerHTML = '<div class="alert alert-info">No results found</div>';
            } else {
                let html = '';
                results.forEach((faq, index) => {
                    if (faq.answer) {
                        const processedAnswer = renderMarkdown(faq.answer);
                        const cleanQuestion = stripMarkdown(faq.question);
                        html += `
                                <div class="faq-item">
                                    <div class="card">
                                        <div class="card-header faq-question" onclick="toggleSearchFAQ(${index})">
                                            <h6 class="mb-0">ðŸ”¸ ${cleanQuestion}</h6>
                                            <small class="text-muted">${faq.category_name}</small>
                                        </div>
                                        <div id="search-faq-${index}" class="faq-answer">
                                            <div class="faq-feedback-box">
                                                <small class="text-muted">
                                                    ðŸ’¡ Have additional info or corrections about this FAQ? 
                                                    <button class="btn btn-link btn-sm p-0 text-decoration-none" 
                                                            onclick="openFeedbackModal(${faq.id}, '${cleanQuestion.replace(/'/g, "\\'")}')">
                                                        ï¿½ Submit feedback
                                                    </button>
                                                </small>
                                            </div>
                                            <div class="card-body">
                                                ${processedAnswer}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                    }
                });
                document.getElementById('searchResults').innerHTML = html;
            }

            showSection('searchSection');
        } catch (error) {
            alert('Search error: ' + error.message);
        }
    }

    // Toggle search FAQ answer visibility
    function toggleSearchFAQ(index) {
        const answer = document.getElementById(`search-faq-${index}`);
        answer.style.display = answer.style.display === 'block' ? 'none' : 'block';
    }

    // Admin panel function
    function openAdmin() {
        // Try multiple methods to open admin panel
        try {
            // Method 1: window.open
            const adminWindow = window.open('admin.html', '_blank');
            if (!adminWindow) {
                // Method 2: direct navigation
                window.location.href = 'admin.html';
            }
        } catch (error) {
            // Method 3: fallback
            alert('Please navigate to: ' + window.location.origin + '/admin.html');
        }
    }

    // Open feedback modal
    function openFeedbackModal(faqId, faqQuestion) {
        document.getElementById('feedbackFaqId').value = faqId;
        document.getElementById('feedbackFaqQuestion').value = faqQuestion;
        document.getElementById('feedbackFaqDisplay').textContent = faqQuestion;

        // Clear form
        document.getElementById('feedbackText').value = '';
        document.getElementById('feedbackEmail').value = '';

        // Show modal
        new bootstrap.Modal(document.getElementById('feedbackModal')).show();
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded');

        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchFAQs();
        });

        // Attach FAQ feedback form submission handler
        const feedbackForm = document.getElementById('feedbackForm');
        if (feedbackForm) {
            feedbackForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Submitting FAQ feedbackâ€¦');

                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn ? submitBtn.textContent : 'Submit';
                if (submitBtn) {
                    submitBtn.textContent = 'Submitting...';
                    submitBtn.disabled = true;
                }

                try {
                    const faqId = document.getElementById('feedbackFaqId').value;
                    const faqQuestion = document.getElementById('feedbackFaqQuestion').value;
                    const feedbackText = document.getElementById('feedbackText').value;
                    const userEmail = document.getElementById('feedbackEmail').value;

                    const response = await fetch('https://feedback.dieselsubs.com/api/submit.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            faq_id: faqId,
                            faq_question: faqQuestion,
                            feedback_text: feedbackText,
                            user_email: userEmail
                        })
                    });

                    const data = await response.json();
                    console.log('FAQ submit.php response:', data);

                    if (data.success) {
                        bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
                        alert('Thank you for your feedback! We really appreciate your input.');
                    } else {
                        alert('Error submitting feedback: ' + (data.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('FAQ feedback submission error:', error);
                    alert('Error submitting feedback. Please try again.');
                } finally {
                    if (submitBtn) {
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                }
            });
        } else {
            console.error('feedbackForm not found in DOM');
        }

        // General Feedback Modal logic
        function openGeneralFeedbackModal() {
            document.getElementById('generalFeedbackText').value = '';
            document.getElementById('generalFeedbackEmail').value = '';
            new bootstrap.Modal(document.getElementById('generalFeedbackModal')).show();
        }
        window.openGeneralFeedbackModal = openGeneralFeedbackModal;

        // Attach GENERAL feedback form submission handler
        const generalFeedbackForm = document.getElementById('generalFeedbackForm');
        if (generalFeedbackForm) {
            generalFeedbackForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn ? submitBtn.textContent : 'Submit';
                if (submitBtn) {
                    submitBtn.textContent = 'Submitting...';
                    submitBtn.disabled = true;
                }

                try {
                    const feedbackText = document.getElementById('generalFeedbackText').value;
                    const userEmail = document.getElementById('generalFeedbackEmail').value;

                    const response = await fetch('https://feedback.dieselsubs.com/api/submit.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            faq_id: null,                      // general feedback
                            faq_question: 'General Feedback',  // label in DB/email
                            feedback_text: feedbackText,
                            user_email: userEmail
                        })
                    });

                    const data = await response.json();
                    console.log('generalFeedbackForm submit.php response:', data);

                    if (data.success) {
                        bootstrap.Modal.getInstance(document.getElementById('generalFeedbackModal')).hide();
                        alert('Thank you for your feedback! We really appreciate your input.');
                    } else {
                        alert('Error submitting feedback: ' + (data.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('General feedback submission error:', error);
                    alert('Error submitting feedback. Please try again.');
                } finally {
                    if (submitBtn) {
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                }
            });
        } else {
            console.error('generalFeedbackForm not found in DOM');
        }

        loadCategories();
    });
</script>